无人机视觉系统对抗攻击检测与防御 —— 部署实施指南
============================================

## 1. 项目概览
- **目标**：构建一套无人机视觉模型的对抗攻击检测与防御实验平台，支持数据采集、模型训练、对抗样本生成、防御策略验证与可视化分析。
- **核心模块**：
  - 数据管理：VisDrone 等场景数据集下载、清洗与版本化。
  - 基线模型：YOLOv8/YOLOv5 等目标检测模型训练与评估。
  - 对抗攻击：FGSM、PGD、DI²-FGSM 等攻击生成与批量评估。
  - 检测防御：输入一致性检测、模型蒸馏、特征压缩等策略。
  - 结果分析：实验日志、混淆矩阵、可视化样例、实验报告导出。
- **部署模式**：单机（Windows 10/11 + NVIDIA GPU）或双机（训练 + 推理分离）。

## 2. 技术栈与工具
- **语言与框架**：Python 3.10、PyTorch 2.0.x、Ultralytics YOLOv8、Torchvision。
- **对抗库**：Adversarial Robustness Toolbox (ART) 或 Foolbox。
- **数据处理**：Pandas、NumPy、OpenCV、Albumentations。
- **可视化**：Matplotlib、Seaborn、Plotly、Streamlit。
- **实验管理**：MLflow + SQLite/PostgreSQL 后端，TensorBoard（可选）。
- **自动化脚本**：PowerShell（Windows）、Bash（Linux）。
- **环境管理**：Anaconda/Miniconda。
- **硬件要求**：NVIDIA GPU（>=8GB 显存），CUDA 11.8，cuDNN 兼容版本。

## 3. 前置准备
1. **安装 Anaconda/Miniconda**（若已安装可跳过）。
2. **安装 NVIDIA 驱动与 CUDA Toolkit 11.8**，确保 `nvcc --version` 正常。
3. **安装 Git、PowerShell 7（建议）**。
4. **准备数据存储目录**：确保磁盘剩余空间 > 50GB。

## 4. 目录结构约定
```
D:\UAV_Adversarial_Security\
├─ data\
│  ├─ raw\                # 原始数据集（VisDrone 等）
│  ├─ yolo\               # 转换后的 YOLO 数据
│  └─ adversarial\        # 对抗样本及缓存                 http://localhost:5000
├─ runs\
│  ├─ train\              # YOLO 训练输出
│  ├─ val\                # 验证输出
│  └─ attack_eval\        # 对抗攻击评估结果
├─ logs\
│  ├─ mlflow\
│  └─ tensorboard\
├─ scripts\
│  ├─ download_datasets.ps1
│  ├─ visdrone_to_yolo.py
│  ├─ train_baseline.py
│  ├─ generate_attacks.py
│  ├─ detect_defense.py
│  └─ report_builder.py
├─ src\
│  ├─ attacks\
│  │  ├─ fgsm.py
│  │  ├─ pgd.py
│  │  └─ di_fgsm.py
│  ├─ defenses\
│  │  ├─ input_consistency.py
│  │  ├─ feature_compression.py
│  │  └─ model_distillation.py
│  ├─ models\
│  │  └─ yolo_wrapper.py
│  ├─ utils\
│  │  ├─ data_utils.py
│  │  ├─ visualization.py
│  │  └─ metrics.py
│  └─ pipeline.py
├─ streamlit_app\
│  ├─ app.py
│  └─ assets\
└─ README.md
```

## 5. 环境配置步骤
> 若尚未创建项目根目录，可先执行：
```powershell
if (-not (Test-Path D:\UAV_Adversarial_Security)) {
  New-Item -Path D:\UAV_Adversarial_Security -ItemType Directory | Out-Null
}
```

### 5.1 创建 Conda 环境
```powershell
Set-Location D:\UAV_Adversarial_Security
conda create -n uav_adv python=3.10 -y
conda activate uav_adv
```

### 5.2 安装 PyTorch + CUDA
```powershell
pip install torch==2.0.1+cu118 torchvision==0.15.2+cu118 --index-url https://download.pytorch.org/whl/cu118
```

### 5.3 安装基础依赖
> 为避免依赖相互升级，逐条执行以下命令（不要使用换行符 `^`），必要时加 `--force-reinstall`。
```powershell
pip install --upgrade --force-reinstall numpy==1.23.5
pip install --upgrade --force-reinstall scipy==1.9.3
pip install --upgrade --force-reinstall scikit-learn==1.1.3
pip install --no-deps pandas==2.0.3
pip install --no-deps opencv-python-headless==4.9.0.80
pip install --no-deps seaborn==0.13.0
pip install --no-deps matplotlib==3.7.2
pip install --no-deps pillow==9.5.0
pip install torch==2.0.1+cu118 torchvision==0.15.2+cu118 --index-url https://download.pytorch.org/whl/cu118
pip install --no-deps ultralytics==8.2.74
pip install --no-deps onnxruntime-gpu==1.17.1
pip install --no-deps adversarial-robustness-toolbox==1.17.0
pip install --no-deps albumentations==1.3.1
pip install --no-deps albucore==0.0.7
pip install --no-deps tqdm==4.66.2
pip install --no-deps rich==13.7.1
pip install --no-deps typer==0.12.3
pip install --no-deps hydra-core==1.3.2
pip install --no-deps mlflow==2.8.1
pip install --no-deps streamlit==1.37.1
pip install --no-deps plotly==5.23.0
pip install --no-deps tensorboard==2.15.1
pip install --no-deps aiohttp==3.9.5
pip install --no-deps protobuf==4.23.4
```
> 若安装 `mlflow` 后发现 `numpy` 或 `scikit-learn` 被升级，可再次执行前三条命令恢复版本。

### 5.3.1 安装完成后的检查
```powershell
pip show numpy scipy scikit-learn pandas opencv-python-headless ultralytics adversarial-robustness-toolbox mlflow streamlit
```

### 5.4 安装可选组件
```powershell
pip install tensorboard==2.15.1 aiohttp==3.9.5
```

## 6. 数据集准备
### 6.1 下载 VisDrone 数据集
```powershell
Set-Location D:\UAV_Adversarial_Security\data\raw
Invoke-WebRequest -Uri "https://github.com/VisDrone/VisDrone-Dataset/releases/download/V1.0/VisDrone2019-DET-train.zip" -OutFile train.zip
Invoke-WebRequest -Uri "https://github.com/VisDrone/VisDrone-Dataset/releases/download/V1.0/VisDrone2019-DET-val.zip" -OutFile val.zip
Expand-Archive -Path train.zip -DestinationPath .
Expand-Archive -Path val.zip -DestinationPath .
Remove-Item train.zip, val.zip
```

### 6.2 转换为 YOLO 格式
```powershell
Set-Location D:\UAV_Adversarial_Security
python scripts\visdrone_to_yolo.py `
  --src data\raw `
  --dst data\yolo `
  --img-width 960 --img-height 540
```

### 6.3 验证目录结构
```powershell
Get-ChildItem data\yolo -Depth 2
```

## 7. 基线模型训练
### 7.1 YOLOv8 配置
新建 `configs\yolov8_visdrone.yaml`，内容包括数据路径、类别名称、训练超参（epochs=50, imgsz=640, batch=16 等）。

### 7.2 启动训练
```powershell
Set-Location D:\UAV_Adversarial_Security
yolo detect train `
  data=configs\yolov8_visdrone.yaml `
  model=yolov8n.pt `
  epochs=50 imgsz=640 batch=16 `
  project=runs\train name=yolov8n_visdrone `
  workers=4 device=0
```

### 7.3 训练日志与模型
- 输出路径：`runs\train\yolov8n_visdrone`
- 关注：`results.png`、`confusion_matrix.png`、`weights\best.pt`

## 8. 对抗攻击生成
### 8.1 配置攻击脚本
`scripts\generate_attacks.py` 主要步骤：
1. 加载 baseline 模型权重。
2. 对验证集样本构建 DataLoader。
3. 使用 ART/Foolbox 生成对抗样本（FGSM、PGD 等）。
4. 保存对抗样本与攻击元数据至 `data\adversarial\{attack_name}\`.

### 8.2 PowerShell 执行示例
```powershell
python scripts\generate_attacks.py `
  --weights runs\train\yolov8n_visdrone\weights\best.pt `
  --data data\yolo\val\images `
  --attack fgsm `
  --eps 0.015 `
  --output data\adversarial\fgsm
```

## 9. 对抗检测与防御
### 9.1 检测模块
- 输入一致性检测：对同一帧进行多次增广推理，统计预测漂移。
- 特征重建检测：提取中间层特征，用自编码器判断重构误差。

### 9.2 防御模块
- 对抗训练：混合原始与对抗样本进行进一步训练。
- 模型蒸馏：蒸馏生成更平滑的决策边界。
- 特征压缩：使用 PCA 或随机投影降低输入敏感性。

### 9.3 执行示例
```powershell
python scripts\detect_defense.py `
  --weights runs\train\yolov8n_visdrone\weights\best.pt `
  --attack-dir data\adversarial\fgsm `
  --defense input_consistency `
  --threshold 0.15 `
  --report runs\attack_eval\fgsm_consistency.json
```

## 10. 实验管理与可视化
- **MLflow**：记录训练/攻击/防御实验，命令示例：
  ```powershell
  mlflow server `
    --backend-store-uri sqlite:///logs/mlflow/mlflow.db `
    --default-artifact-root file:///D:/UAV_Adversarial_Security/logs/mlflow/artifacts `
    --host 0.0.0.0 --port 5000
  ```
- **Streamlit Dashboard**：`streamlit run streamlit_app\app.py` 展示数据流。
- **TensorBoard**（可选）：`tensorboard --logdir runs`

## 11. 实验流程建议
1. **基线训练**：确保模型达到预期精度（mAP、Precision、Recall）。
2. **攻击生成**：分别对验证集生成 FGSM / PGD / DI²-FGSM 样本。
3. **检测评估**：测量检测准确率、漏报率、误报率。
4. **防御策略**：对比不同防御策略对模型性能的影响。
5. **可视化分析**：对对抗样本、检测结果、性能曲线进行统一展示。
6. **报告生成**：使用 `scripts\report_builder.py` 汇总结果并生成 Markdown/PDF。

## 12. 验证与测试
- **功能测试**：检查每个脚本可独立运行，并与 MLflow 日志联动。
- **性能测试**：记录单次攻击生成与防御推理的耗时。
- **鲁棒性测试**：针对不同天气、光照条件的样本进行评估。
- **安全测试**：模拟异常输入（空帧、噪声）验证系统处理能力。

## 13. 常见问题排查
- **显存不足**：调小 `batch`、`imgsz` 或关掉 mosaic 增强。
- **CUDA 初始化失败**：确认驱动、CUDA、PyTorch CUDA 包匹配。
- **对抗样本无效**：检查 `eps`、迭代次数；确保攻击针对训练模式（eval 模式）。
- **MLflow 无法访问**：确认防火墙规则，或改用 `127.0.0.1`。
- **Streamlit 无法加载图片**：检查路径是否为绝对路径或 `Path` 统一转换。

## 14. 扩展方向
- 接入实时视频流，模拟无人机实时推流防御。
- 引入多模态传感器（红外、雷达）进行跨模态防御。
- 设计自动化评测脚本，批量对比多种攻击与防御组合。
- 将实验结果对接 Power BI 或 Grafana 实现持续监控。

## 15. 交付物建议
- 源代码仓库（含 README、环境文件、脚本）。
- `部署日志` + `实验报告（含截图）`。
- MLflow 跑通记录（截图或导出的 HTML 报告）。
- 对抗样本与防御策略的定量对比表格。

---
如需进一步细化某一步的脚本或自动化流程，可以继续在对应章节扩充。建议先按照上述步骤完成基础环境与数据准备，再逐步实现攻击/防御模块并进行联调。


