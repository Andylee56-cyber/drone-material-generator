# ⚡ 快速优化执行指南

## 🎯 目标
在5分钟内完成所有优化，让演示流畅运行

---

## 📝 执行步骤（按顺序）

### 第一步：添加Swap空间（1分钟）

在服务器SSH终端执行：

```bash
# 创建2GB swap
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 验证
free -h
```

**应该看到：** Swap行显示约2GB

---

### 第二步：应用系统优化（1分钟）

```bash
# 上传优化脚本到服务器，或直接执行
bash apply_optimizations.sh
```

或者手动执行：

```bash
# 优化内核参数
cat >> /etc/sysctl.conf << 'EOF'
vm.swappiness = 10
vm.dirty_ratio = 60
vm.dirty_background_ratio = 2
net.core.somaxconn = 1024
EOF
sysctl -p
```

---

### 第三步：优化代码（2分钟）

#### 3.1 在 `streamlit_app.py` 开头添加：

```python
import streamlit as st
import torch
import gc

# 性能优化设置
if not torch.cuda.is_available():
    torch.set_num_threads(1)
    torch.set_grad_enabled(False)

# 模型缓存
@st.cache_resource
def load_model():
    """加载模型，只执行一次"""
    model = DroneVisionCNN(num_classes=5)
    model.eval()
    return model
```

#### 3.2 在推理函数前添加：

```python
@st.cache_data(max_entries=10)
def predict_image(model, image_tensor):
    """预测图片，带缓存"""
    with torch.no_grad():
        output = model(image_tensor)
        return output
```

---

### 第四步：重启Streamlit（1分钟）

```bash
# 停止当前Streamlit
pkill -f streamlit

# 使用优化脚本启动
cd /root/mlflow_learning_project  # 你的项目路径
export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
nohup streamlit run streamlit_app.py \
    --server.port 8501 \
    --server.headless true \
    --server.address 127.0.0.1 \
    --server.maxUploadSize 200 \
    > /tmp/streamlit.log 2>&1 &

# 检查是否启动
sleep 3
ps aux | grep streamlit
```

---

## ✅ 验证优化效果

```bash
# 1. 检查内存
free -h
# 应该看到Swap有2GB

# 2. 检查服务
systemctl status nginx
ps aux | grep streamlit

# 3. 测试访问
curl -k https://127.0.0.1 | head -20
```

---

## 🎯 演示前准备

### 1. 预热系统（重要！）

演示前5分钟：
1. 访问 `https://8.129.225.152`
2. 上传一张小测试图片
3. 让模型加载完成
4. 这样演示时就不会卡在模型加载

### 2. 准备测试图片

- 使用小图片（< 500KB）
- 分辨率不要太大（建议 < 1024x1024）
- 格式：JPG或PNG

### 3. 演示流程

1. **打开系统** → 展示界面
2. **上传图片** → 等待处理（30-60秒）
3. **展示结果** → 强调技术优势
4. **说明应用** → 可部署到无人机

---

## 💡 演示话术

**开场：**
> "这是我们开发的无人机视觉智能分析系统，已经部署在云端，可以通过HTTPS安全访问。"

**展示功能：**
> "系统支持实时图像分析、多角度素材生成，以及8个维度的智能分析。"

**强调技术：**
> "使用深度学习CNN模型，支持实时推理，可以部署到大疆无人机平台。"

**说明优势：**
> "系统具有高准确率、实时性强、可扩展性好的特点，适合无人机应用场景。"

---

## ⚠️ 如果还是慢

### 应急方案：

1. **使用预生成结果**
   - 提前准备好演示结果
   - 演示时直接展示结果页面

2. **降低图片分辨率**
   - 演示时使用更小的图片（256x256）

3. **分批演示**
   - 不要连续操作
   - 每次操作后等待完成

---

## 🎉 完成！

优化完成后，系统应该可以流畅运行了！

**访问地址：** `https://8.129.225.152`

**给老板的链接：** 直接发送HTTPS地址即可

