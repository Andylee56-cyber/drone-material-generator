# ç¬¬7å‘¨ï¼šç´ æè‡ªåŠ¨å¢å¼ºè®­ç»ƒç³»ç»Ÿéƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†æ™ºèƒ½ç´ æå¢å¼ºè®­ç»ƒåŠŸèƒ½ï¼Œå½“å›¾ç‰‡è´¨é‡ç»¼åˆæ‰“åˆ†å±äºè¾ƒå·®æ°´å¹³ï¼ˆ<60åˆ†ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åº”ç”¨å¤šç§ä¼˜åŒ–ç®—æ³•å¯¹ç´ æè¿›è¡Œè¿­ä»£å¢å¼ºï¼Œç›´åˆ°è¾¾åˆ°ä¼˜ç§€æ°´å¹³ï¼ˆâ‰¥90åˆ†ï¼‰ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. **æ™ºèƒ½è´¨é‡è¯„ä¼°**ï¼šè‡ªåŠ¨è¯†åˆ«è´¨é‡è¾ƒå·®çš„ç´ æ
2. **å¤šç®—æ³•é›†æˆå¢å¼º**ï¼šæ ¹æ®ä½åˆ†ç»´åº¦è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¢å¼ºç®—æ³•
3. **è¿­ä»£è®­ç»ƒ**ï¼šè‡ªåŠ¨è¿­ä»£å¢å¼ºç›´åˆ°è¾¾åˆ°ä¼˜ç§€æ°´å¹³
4. **å¯è§†åŒ–åé¦ˆ**ï¼šå®æ—¶æ˜¾ç¤ºå¢å¼ºè¿›åº¦å’Œæ•ˆæœå¯¹æ¯”

### æŠ€æœ¯æ ˆ
- **å›¾åƒå¢å¼ºç®—æ³•**ï¼šå¯¹æ¯”åº¦å¢å¼ºã€é”åŒ–ã€å»å™ªã€è¶…åˆ†è¾¨ç‡ã€è‰²å½©å¢å¼ºã€å…‰ç…§æ ¡æ­£
- **æ™ºèƒ½é€‰æ‹©**ï¼šåŸºäº8ç»´åº¦åˆ†æç»“æœè‡ªåŠ¨é€‰æ‹©å¢å¼ºç­–ç•¥
- **è¿­ä»£ä¼˜åŒ–**ï¼šè‡ªé€‚åº”è¿­ä»£æ¬¡æ•°ï¼Œç¡®ä¿è¾¾åˆ°ç›®æ ‡è´¨é‡

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºç´ æå¢å¼ºè®­ç»ƒå™¨æ¨¡å—

åœ¨PowerShellä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ ¸å¿ƒå¢å¼ºæ¨¡å—ï¼š

```powershell
# åˆ›å»ºagentsç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if (-not (Test-Path "agents")) { New-Item -ItemType Directory -Path "agents" }

# åˆ›å»ºç´ æå¢å¼ºè®­ç»ƒå™¨
@'
"""
ç´ æè‡ªåŠ¨å¢å¼ºè®­ç»ƒå™¨
Material Enhancement Trainer
é›†æˆå¤šç§ä¼˜åŒ–ç®—æ³•ï¼Œè‡ªåŠ¨æå‡ç´ æè´¨é‡åˆ°ä¼˜ç§€æ°´å¹³
"""

import numpy as np
import cv2
from PIL import Image, ImageEnhance, ImageFilter
from pathlib import Path
from typing import Dict, List, Optional, Tuple
import random
from datetime import datetime
from agents.image_quality_analyzer import ImageQualityAnalyzer
from agents.material_generator_agent import MaterialGeneratorAgent


class MaterialEnhancementTrainer:
    """ç´ æè‡ªåŠ¨å¢å¼ºè®­ç»ƒå™¨"""
    
    def __init__(self, yolo_model_path: Optional[str] = None):
        """
        åˆå§‹åŒ–å¢å¼ºè®­ç»ƒå™¨
        
        å‚æ•°:
            yolo_model_path: YOLOæ¨¡å‹è·¯å¾„
        """
        self.analyzer = ImageQualityAnalyzer(yolo_model_path)
        self.agent = MaterialGeneratorAgent(yolo_model_path)
        self.target_score = 90.0  # ç›®æ ‡è´¨é‡åˆ†æ•°ï¼ˆä¼˜ç§€æ°´å¹³ï¼‰
        self.max_iterations = 10  # æœ€å¤§è¿­ä»£æ¬¡æ•°
        self.enhancement_history = []  # å¢å¼ºå†å²è®°å½•
    
    def enhance_to_excellent(
        self,
        image_path: str,
        output_dir: str,
        target_score: float = 90.0,
        max_iterations: int = 10
    ) -> Dict:
        """
        å°†ç´ æå¢å¼ºåˆ°ä¼˜ç§€æ°´å¹³
        
        å‚æ•°:
            image_path: è¾“å…¥å›¾ç‰‡è·¯å¾„
            output_dir: è¾“å‡ºç›®å½•
            target_score: ç›®æ ‡è´¨é‡åˆ†æ•°
            max_iterations: æœ€å¤§è¿­ä»£æ¬¡æ•°
            
        è¿”å›:
            å¢å¼ºç»“æœå­—å…¸
        """
        input_path = Path(image_path)
        output_path = Path(output_dir)
        output_path.mkdir(parents=True, exist_ok=True)
        
        if not input_path.exists():
            raise FileNotFoundError(f"è¾“å…¥å›¾ç‰‡ä¸å­˜åœ¨: {image_path}")
        
        # è¯»å–åŸå§‹å›¾ç‰‡
        img = cv2.imread(str(input_path))
        if img is None:
            pil_img = Image.open(input_path)
            img = cv2.cvtColor(np.array(pil_img), cv2.COLOR_RGB2BGR)
        
        current_img = img.copy()
        iteration_history = []
        
        # è¿­ä»£å¢å¼º
        for iteration in range(max_iterations):
            # åˆ†æå½“å‰å›¾ç‰‡è´¨é‡
            temp_path = output_path / f"temp_iter_{iteration}.jpg"
            cv2.imwrite(str(temp_path), current_img)
            
            analysis_result = self.analyzer.analyze_single_image(str(temp_path))
            scores = [analysis_result[dim] for dim in self.analyzer.dimensions]
            current_score = np.mean(scores)
            
            iteration_history.append({
                'iteration': iteration + 1,
                'score': current_score,
                'dimension_scores': analysis_result.copy()
            })
            
            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡
            if current_score >= target_score:
                # ä¿å­˜æœ€ç»ˆå¢å¼ºç»“æœ
                final_path = output_path / f"enhanced_final_{input_path.stem}.jpg"
                cv2.imwrite(str(final_path), current_img, [cv2.IMWRITE_JPEG_QUALITY, 95])
                temp_path.unlink()  # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
                
                return {
                    'success': True,
                    'target_achieved': True,
                    'final_score': current_score,
                    'iterations': iteration + 1,
                    'final_image_path': str(final_path),
                    'enhancement_history': iteration_history,
                    'improvement': current_score - iteration_history[0]['score']
                }
            
            # æ ¹æ®ä½åˆ†ç»´åº¦é€‰æ‹©å¢å¼ºç­–ç•¥
            enhancement_strategy = self._select_enhancement_strategy(analysis_result)
            
            # åº”ç”¨å¢å¼º
            current_img = self._apply_enhancements(current_img, enhancement_strategy)
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            if temp_path.exists():
                temp_path.unlink()
        
        # è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œä¿å­˜å½“å‰æœ€ä½³ç»“æœ
        final_path = output_path / f"enhanced_final_{input_path.stem}.jpg"
        cv2.imwrite(str(final_path), current_img, [cv2.IMWRITE_JPEG_QUALITY, 95])
        
        return {
            'success': True,
            'target_achieved': False,
            'final_score': iteration_history[-1]['score'],
            'iterations': max_iterations,
            'final_image_path': str(final_path),
            'enhancement_history': iteration_history,
            'improvement': iteration_history[-1]['score'] - iteration_history[0]['score']
        }
    
    def enhance_batch_to_excellent(
        self,
        image_paths: List[str],
        output_dir: str,
        target_score: float = 90.0,
        max_iterations: int = 10
    ) -> Dict:
        """
        æ‰¹é‡å¢å¼ºç´ æåˆ°ä¼˜ç§€æ°´å¹³
        
        å‚æ•°:
            image_paths: å›¾ç‰‡è·¯å¾„åˆ—è¡¨
            output_dir: è¾“å‡ºç›®å½•
            target_score: ç›®æ ‡è´¨é‡åˆ†æ•°
            max_iterations: æœ€å¤§è¿­ä»£æ¬¡æ•°
            
        è¿”å›:
            æ‰¹é‡å¢å¼ºç»“æœ
        """
        output_path = Path(output_dir)
        output_path.mkdir(parents=True, exist_ok=True)
        
        batch_results = []
        for img_path in image_paths:
            try:
                img_output_dir = output_path / Path(img_path).stem
                result = self.enhance_to_excellent(
                    img_path, str(img_output_dir), target_score, max_iterations
                )
                result['original_path'] = img_path
                batch_results.append(result)
            except Exception as e:
                batch_results.append({
                    'success': False,
                    'original_path': img_path,
                    'error': str(e)
                })
        
        # ç»Ÿè®¡ç»“æœ
        successful = [r for r in batch_results if r.get('success', False)]
        achieved = [r for r in successful if r.get('target_achieved', False)]
        
        return {
            'total_images': len(image_paths),
            'successful': len(successful),
            'target_achieved': len(achieved),
            'results': batch_results,
            'success_rate': len(successful) / len(image_paths) * 100 if image_paths else 0,
            'achievement_rate': len(achieved) / len(successful) * 100 if successful else 0
        }
    
    def _select_enhancement_strategy(self, dimension_scores: Dict) -> List[str]:
        """
        æ ¹æ®ç»´åº¦å¾—åˆ†é€‰æ‹©å¢å¼ºç­–ç•¥
        
        å‚æ•°:
            dimension_scores: 8ç»´åº¦å¾—åˆ†å­—å…¸
            
        è¿”å›:
            å¢å¼ºç­–ç•¥åˆ—è¡¨
        """
        strategies = []
        threshold = 60.0  # ä½äº60åˆ†çš„ç»´åº¦éœ€è¦å¢å¼º
        
        # 1. å›¾ç‰‡æ•°æ®é‡ä½ -> è¶…åˆ†è¾¨ç‡å¢å¼º
        if dimension_scores.get('å›¾ç‰‡æ•°æ®é‡', 100) < threshold:
            strategies.append('super_resolution')
        
        # 2. æ‹æ‘„å…‰ç…§è´¨é‡ä½ -> å…‰ç…§æ ¡æ­£ + å¯¹æ¯”åº¦å¢å¼º
        if dimension_scores.get('æ‹æ‘„å…‰ç…§è´¨é‡', 100) < threshold:
            strategies.append('lighting_correction')
            strategies.append('contrast_enhancement')
        
        # 3. ç›®æ ‡å°ºå¯¸ä½ -> é”åŒ– + è¾¹ç¼˜å¢å¼º
        if dimension_scores.get('ç›®æ ‡å°ºå¯¸', 100) < threshold:
            strategies.append('sharpen')
            strategies.append('edge_enhancement')
        
        # 4. ç›®æ ‡å®Œæ•´æ€§ä½ -> å»å™ª + é”åŒ–
        if dimension_scores.get('ç›®æ ‡å®Œæ•´æ€§', 100) < threshold:
            strategies.append('denoise')
            strategies.append('sharpen')
        
        # 5. æ•°æ®å‡è¡¡åº¦ä½ -> è‰²å½©å¢å¼º
        if dimension_scores.get('æ•°æ®å‡è¡¡åº¦', 100) < threshold:
            strategies.append('color_enhancement')
        
        # 6. äº§å“ä¸°å¯Œåº¦ä½ -> å¯¹æ¯”åº¦å¢å¼º + é”åŒ–
        if dimension_scores.get('äº§å“ä¸°å¯Œåº¦', 100) < threshold:
            strategies.append('contrast_enhancement')
            strategies.append('sharpen')
        
        # 7. ç›®æ ‡å¯†é›†åº¦ä½ -> æ•´ä½“å¢å¼º
        if dimension_scores.get('ç›®æ ‡å¯†é›†åº¦', 100) < threshold:
            strategies.append('overall_enhancement')
        
        # 8. åœºæ™¯å¤æ‚åº¦ä½ -> çº¹ç†å¢å¼º + é”åŒ–
        if dimension_scores.get('åœºæ™¯å¤æ‚åº¦', 100) < threshold:
            strategies.append('texture_enhancement')
            strategies.append('sharpen')
        
        # å¦‚æœæ²¡æœ‰ç‰¹å®šç­–ç•¥ï¼Œåº”ç”¨é€šç”¨å¢å¼º
        if not strategies:
            strategies = ['overall_enhancement', 'sharpen', 'contrast_enhancement']
        
        return strategies
    
    def _apply_enhancements(self, img: np.ndarray, strategies: List[str]) -> np.ndarray:
        """
        åº”ç”¨å¢å¼ºç­–ç•¥
        
        å‚æ•°:
            img: è¾“å…¥å›¾ç‰‡ï¼ˆBGRæ ¼å¼ï¼‰
            strategies: å¢å¼ºç­–ç•¥åˆ—è¡¨
            
        è¿”å›:
            å¢å¼ºåçš„å›¾ç‰‡
        """
        result = img.copy()
        
        for strategy in strategies:
            if strategy == 'super_resolution':
                result = self._super_resolution(result)
            elif strategy == 'lighting_correction':
                result = self._lighting_correction(result)
            elif strategy == 'contrast_enhancement':
                result = self._contrast_enhancement(result)
            elif strategy == 'sharpen':
                result = self._sharpen(result)
            elif strategy == 'edge_enhancement':
                result = self._edge_enhancement(result)
            elif strategy == 'denoise':
                result = self._denoise(result)
            elif strategy == 'color_enhancement':
                result = self._color_enhancement(result)
            elif strategy == 'texture_enhancement':
                result = self._texture_enhancement(result)
            elif strategy == 'overall_enhancement':
                result = self._overall_enhancement(result)
        
        return result
    
    def _super_resolution(self, img: np.ndarray) -> np.ndarray:
        """è¶…åˆ†è¾¨ç‡å¢å¼ºï¼ˆä½¿ç”¨æ’å€¼æ”¾å¤§ï¼‰"""
        h, w = img.shape[:2]
        # æ”¾å¤§1.2å€
        result = cv2.resize(img, (int(w * 1.2), int(h * 1.2)), interpolation=cv2.INTER_LANCZOS4)
        # è£å‰ªå›åŸå°ºå¯¸ï¼ˆä¿æŒä¸­å¿ƒï¼‰
        h_new, w_new = result.shape[:2]
        start_y = (h_new - h) // 2
        start_x = (w_new - w) // 2
        result = result[start_y:start_y+h, start_x:start_x+w]
        return result
    
    def _lighting_correction(self, img: np.ndarray) -> np.ndarray:
        """å…‰ç…§æ ¡æ­£"""
        # è½¬æ¢ä¸ºLABè‰²å½©ç©ºé—´
        lab = cv2.cvtColor(img, cv2.COLOR_BGR2LAB)
        l, a, b = cv2.split(lab)
        
        # ä½¿ç”¨CLAHEï¼ˆå¯¹æ¯”åº¦å—é™çš„è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼‰
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
        l = clahe.apply(l)
        
        # åˆå¹¶é€šé“
        lab = cv2.merge([l, a, b])
        result = cv2.cvtColor(lab, cv2.COLOR_LAB2BGR)
        return result
    
    def _contrast_enhancement(self, img: np.ndarray) -> np.ndarray:
        """å¯¹æ¯”åº¦å¢å¼º"""
        # è½¬æ¢ä¸ºYUVè‰²å½©ç©ºé—´
        yuv = cv2.cvtColor(img, cv2.COLOR_BGR2YUV)
        y, u, v = cv2.split(yuv)
        
        # å¢å¼ºYé€šé“å¯¹æ¯”åº¦
        y = cv2.convertScaleAbs(y, alpha=1.3, beta=10)
        
        # åˆå¹¶é€šé“
        yuv = cv2.merge([y, u, v])
        result = cv2.cvtColor(yuv, cv2.COLOR_YUV2BGR)
        return result
    
    def _sharpen(self, img: np.ndarray) -> np.ndarray:
        """é”åŒ–"""
        kernel = np.array([[-1, -1, -1],
                          [-1,  9, -1],
                          [-1, -1, -1]])
        result = cv2.filter2D(img, -1, kernel)
        return result
    
    def _edge_enhancement(self, img: np.ndarray) -> np.ndarray:
        """è¾¹ç¼˜å¢å¼º"""
        # ä½¿ç”¨æ‹‰æ™®æ‹‰æ–¯ç®—å­
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        laplacian = cv2.Laplacian(gray, cv2.CV_64F)
        laplacian = np.uint8(np.absolute(laplacian))
        
        # å åŠ è¾¹ç¼˜ä¿¡æ¯
        result = cv2.addWeighted(img, 0.8, cv2.cvtColor(laplacian, cv2.COLOR_GRAY2BGR), 0.2, 0)
        return result
    
    def _denoise(self, img: np.ndarray) -> np.ndarray:
        """å»å™ª"""
        result = cv2.fastNlMeansDenoisingColored(img, None, 10, 10, 7, 21)
        return result
    
    def _color_enhancement(self, img: np.ndarray) -> np.ndarray:
        """è‰²å½©å¢å¼º"""
        # è½¬æ¢ä¸ºHSV
        hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)
        h, s, v = cv2.split(hsv)
        
        # å¢å¼ºé¥±å’Œåº¦
        s = cv2.convertScaleAbs(s, alpha=1.2, beta=0)
        
        # åˆå¹¶é€šé“
        hsv = cv2.merge([h, s, v])
        result = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)
        return result
    
    def _texture_enhancement(self, img: np.ndarray) -> np.ndarray:
        """çº¹ç†å¢å¼º"""
        # ä½¿ç”¨åŒè¾¹æ»¤æ³¢ä¿ç•™è¾¹ç¼˜çš„åŒæ—¶å¹³æ»‘çº¹ç†
        result = cv2.bilateralFilter(img, 9, 75, 75)
        # å åŠ é”åŒ–
        result = self._sharpen(result)
        return result
    
    def _overall_enhancement(self, img: np.ndarray) -> np.ndarray:
        """æ•´ä½“å¢å¼ºï¼ˆç»„åˆå¤šç§æ–¹æ³•ï¼‰"""
        result = self._lighting_correction(img)
        result = self._contrast_enhancement(result)
        result = self._sharpen(result)
        return result


if __name__ == "__main__":
    trainer = MaterialEnhancementTrainer()
    result = trainer.enhance_to_excellent(
        "test_image.jpg",
        "enhanced_output",
        target_score=90.0,
        max_iterations=10
    )
    print(f"å¢å¼ºå®Œæˆ: {result}")
'@ | Set-Content "agents\material_enhancement_trainer.py" -Encoding UTF8

Write-Host "âœ… ç´ æå¢å¼ºè®­ç»ƒå™¨æ¨¡å—åˆ›å»ºå®Œæˆ" -ForegroundColor Green
```

### æ­¥éª¤2ï¼šæ›´æ–°agentsåŒ…çš„__init__.py

```powershell
# æ›´æ–°agentsåŒ…çš„åˆå§‹åŒ–æ–‡ä»¶
@'
"""
AgentsåŒ… - æ— äººæœºè§†è§‰æ™ºèƒ½Agentç³»ç»Ÿ
"""

from agents.image_multi_angle_generator import ImageMultiAngleGenerator
from agents.image_quality_analyzer import ImageQualityAnalyzer
from agents.material_generator_agent import MaterialGeneratorAgent
from agents.material_enhancement_trainer import MaterialEnhancementTrainer

__all__ = [
    'ImageMultiAngleGenerator',
    'ImageQualityAnalyzer',
    'MaterialGeneratorAgent',
    'MaterialEnhancementTrainer'
]
'@ | Set-Content "agents\__init__.py" -Encoding UTF8

Write-Host "âœ… agentsåŒ…æ›´æ–°å®Œæˆ" -ForegroundColor Green
```

### æ­¥éª¤3ï¼šæ›´æ–°Streamlitåº”ç”¨ï¼ˆæ·»åŠ å¢å¼ºè®­ç»ƒåŠŸèƒ½ï¼‰

```powershell
# è¯»å–å½“å‰Streamlitåº”ç”¨
$currentApp = Get-Content "app\web\material_generator_app.py" -Raw

# åœ¨å¯¼å…¥éƒ¨åˆ†æ·»åŠ å¢å¼ºè®­ç»ƒå™¨
$newImports = @'
import streamlit as st
import plotly.graph_objects as go
import pandas as pd
import numpy as np
from pathlib import Path
import sys
from PIL import Image
import time
import shutil
from datetime import datetime

project_root = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(project_root))

from agents.image_multi_angle_generator import ImageMultiAngleGenerator
from agents.image_quality_analyzer import ImageQualityAnalyzer
from agents.material_generator_agent import MaterialGeneratorAgent
from agents.material_enhancement_trainer import MaterialEnhancementTrainer
'@

# åˆ›å»ºæ–°çš„Streamlitåº”ç”¨ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
@'
"""
æ— äººæœºç´ æå¤šè§’åº¦ç”Ÿæˆä¸åˆ†æç³»ç»Ÿ - Streamlit Webç•Œé¢ï¼ˆå¸¦å¢å¼ºè®­ç»ƒåŠŸèƒ½ï¼‰
"""

import streamlit as st
import plotly.graph_objects as go
import pandas as pd
import numpy as np
from pathlib import Path
import sys
from PIL import Image
import time
import shutil
from datetime import datetime

project_root = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(project_root))

from agents.image_multi_angle_generator import ImageMultiAngleGenerator
from agents.image_quality_analyzer import ImageQualityAnalyzer
from agents.material_generator_agent import MaterialGeneratorAgent
from agents.material_enhancement_trainer import MaterialEnhancementTrainer

st.set_page_config(page_title="æ— äººæœºç´ æå¤šè§’åº¦ç”Ÿæˆç³»ç»Ÿ", page_icon="ğŸš", layout="wide")
st.title("ğŸš æ— äººæœºç´ æå¤šè§’åº¦ç”Ÿæˆä¸åˆ†æç³»ç»Ÿ")
st.markdown("**åŠŸèƒ½**: è¾“å…¥ä¸€å¼ å›¾ç‰‡ï¼Œè‡ªåŠ¨ç”Ÿæˆå¤šè§’åº¦ç´ æï¼ˆå¸¦æ£€æµ‹æ¡†ï¼‰ï¼Œå¹¶ç”Ÿæˆ8ç»´åº¦é›·è¾¾å›¾åˆ†æå’Œç½®ä¿¡åº¦ç»Ÿè®¡")
st.markdown("**æ–°å¢**: è´¨é‡è¾ƒå·®ç´ æè‡ªåŠ¨å¢å¼ºè®­ç»ƒåŠŸèƒ½")
st.markdown("---")

if 'generator' not in st.session_state:
    st.session_state.generator = ImageMultiAngleGenerator(draw_boxes=True)
if 'agent' not in st.session_state:
    st.session_state.agent = MaterialGeneratorAgent()
if 'enhancement_trainer' not in st.session_state:
    st.session_state.enhancement_trainer = MaterialEnhancementTrainer()
if 'generated_images' not in st.session_state:
    st.session_state.generated_images = []
if 'analysis_results' not in st.session_state:
    st.session_state.analysis_results = None
if 'confidence_stats' not in st.session_state:
    st.session_state.confidence_stats = {}
if 'enhancement_results' not in st.session_state:
    st.session_state.enhancement_results = None

with st.sidebar:
    st.header("âš™ï¸ ç³»ç»Ÿé…ç½®")
    num_generations = st.slider("ç”Ÿæˆå›¾ç‰‡æ•°é‡", 4, 100, 18, 1)
    auto_analyze = st.checkbox("ç”Ÿæˆåè‡ªåŠ¨åˆ†æ", value=True)
    draw_detection_boxes = st.checkbox("ç»˜åˆ¶æ£€æµ‹æ¡†", value=True)
    
    st.markdown("---")
    st.markdown("### ğŸ¯ å¢å¼ºè®­ç»ƒè®¾ç½®")
    enable_enhancement = st.checkbox("å¯ç”¨è‡ªåŠ¨å¢å¼ºè®­ç»ƒ", value=True)
    if enable_enhancement:
        target_score = st.slider("ç›®æ ‡è´¨é‡åˆ†æ•°", 80, 100, 90, 1)
        max_iterations = st.slider("æœ€å¤§è¿­ä»£æ¬¡æ•°", 5, 20, 10, 1)
    
    st.markdown("---")
    st.markdown("### ğŸ’¾ ä¿å­˜è®¾ç½®")
    save_enabled = st.checkbox("å¯ç”¨ä¿å­˜åŠŸèƒ½", value=True)
    if save_enabled:
        save_folder = st.text_input("ä¿å­˜æ–‡ä»¶å¤¹è·¯å¾„", value="D:\\æ— äººæœºç”Ÿæˆç´ æ")
        save_name = st.text_input("ä¿å­˜æ–‡ä»¶å¤¹åç§°ï¼ˆå¯é€‰ï¼‰", value="")
    
    st.markdown("---")
    st.markdown("### ğŸ“Š 8ä¸ªåˆ†æç»´åº¦ï¼ˆç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰")
    
    dimensions_list = [
        ("å›¾ç‰‡æ•°æ®é‡", "åŸºäºå›¾ç‰‡åˆ†è¾¨ç‡å’Œæ–‡ä»¶å¤§å°è¯„ä¼°"),
        ("æ‹æ‘„å…‰ç…§è´¨é‡", "åŸºäºäº®åº¦ã€å¯¹æ¯”åº¦ã€æ›å…‰åº¦è¯„ä¼°"),
        ("ç›®æ ‡å°ºå¯¸", "åŸºäºæ£€æµ‹åˆ°çš„ç›®æ ‡å¹³å‡å°ºå¯¸è¯„ä¼°"),
        ("ç›®æ ‡å®Œæ•´æ€§", "åŸºäºç›®æ ‡æ˜¯å¦è¢«è£å‰ªæˆ–é®æŒ¡è¯„ä¼°"),
        ("æ•°æ®å‡è¡¡åº¦", "åŸºäºä¸åŒç±»åˆ«ç›®æ ‡çš„åˆ†å¸ƒå‡è¡¡æ€§è¯„ä¼°"),
        ("äº§å“ä¸°å¯Œåº¦", "åŸºäºæ£€æµ‹åˆ°çš„ç›®æ ‡ç±»åˆ«æ•°é‡è¯„ä¼°"),
        ("ç›®æ ‡å¯†é›†åº¦", "åŸºäºå•ä½é¢ç§¯å†…çš„ç›®æ ‡æ•°é‡è¯„ä¼°"),
        ("åœºæ™¯å¤æ‚åº¦", "åŸºäºèƒŒæ™¯å¤æ‚åº¦ã€çº¹ç†ä¸°å¯Œåº¦è¯„ä¼°")
    ]
    
    for dim_name, dim_desc in dimensions_list:
        with st.expander(f"ğŸ“Œ {dim_name}", expanded=False):
            st.markdown(f"**è¯´æ˜**: {dim_desc}")
            if st.session_state.analysis_results:
                avg_scores = st.session_state.analysis_results['analysis']['average_scores']
                score = avg_scores.get(dim_name, 0)
                st.metric("å¹³å‡å¾—åˆ†", f"{score:.2f}%")
                
                individual_scores = []
                for result in st.session_state.analysis_results['analysis']['individual_results']:
                    individual_scores.append({
                        'å›¾ç‰‡': Path(result['image_path']).name,
                        'å¾—åˆ†': f"{result.get(dim_name, 0):.2f}%"
                    })
                if individual_scores:
                    st.dataframe(pd.DataFrame(individual_scores), use_container_width=True, hide_index=True)

st.header("ğŸ“¸ ä¸Šä¼ å›¾ç‰‡å¹¶ç”Ÿæˆå¤šè§’åº¦ç´ æ")
uploaded_file = st.file_uploader("ä¸Šä¼ ä¸€å¼ æ— äººæœºå›¾ç‰‡", type=['jpg','jpeg','png','bmp'])

if uploaded_file is not None:
    temp_dir = Path("temp_uploads")
    temp_dir.mkdir(exist_ok=True)
    temp_path = temp_dir / uploaded_file.name
    with open(temp_path, "wb") as f:
        f.write(uploaded_file.getbuffer())

    col1, col2 = st.columns([1,1])
    with col1:
        st.subheader("ğŸ“· åŸå§‹å›¾ç‰‡")
        st.image(uploaded_file, caption="ä¸Šä¼ çš„åŸå§‹å›¾ç‰‡", use_column_width=True)

    with col2:
        st.subheader("ğŸ¯ æ“ä½œ")
        if st.button("ğŸš€ ç”Ÿæˆå¤šè§’åº¦ç´ æå¹¶åˆ†æ", type="primary", use_container_width=True):
            with st.spinner("æ­£åœ¨ç”Ÿæˆå¤šè§’åº¦ç´ æï¼Œè¯·ç¨å€™..."):
                try:
                    # æ›´æ–°ç”Ÿæˆå™¨é…ç½®
                    if draw_detection_boxes != st.session_state.generator.draw_boxes:
                        st.session_state.generator = ImageMultiAngleGenerator(draw_boxes=draw_detection_boxes)
                    
                    # ç¡®å®šè¾“å‡ºç›®å½•
                    if save_enabled and save_folder:
                        base_dir = Path(save_folder)
                        base_dir.mkdir(parents=True, exist_ok=True)
                        if save_name:
                            output_dir = base_dir / save_name
                        else:
                            output_dir = base_dir / f"generation_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
                    else:
                        output_dir = Path("generated_materials") / f"generation_{int(time.time())}"
                    
                    output_dir.mkdir(parents=True, exist_ok=True)
                    
                    progress_bar = st.progress(0)
                    status_text = st.empty()

                    status_text.text("æ­¥éª¤1/2: æ­£åœ¨ç”Ÿæˆå¤šè§’åº¦ç´ æï¼ˆå¸¦æ£€æµ‹æ¡†ï¼‰...")
                    result = st.session_state.generator.generate_multi_angle_images(
                        input_image_path=str(temp_path),
                        output_dir=str(output_dir),
                        num_generations=num_generations
                    )
                    progress_bar.progress(50)
                    status_text.text(f"âœ… å·²ç”Ÿæˆ {result['num_generated']} å¼ ç´ æ")
                    st.session_state.generated_images = result['generated_files']
                    st.session_state.confidence_stats = result.get('confidence_statistics', {})

                    if auto_analyze:
                        status_text.text("æ­¥éª¤2/2: æ­£åœ¨åˆ†æç”Ÿæˆçš„ç´ æ...")
                        analysis_result = st.session_state.agent.analyze_and_evaluate(
                            result['generated_files']
                        )
                        st.session_state.analysis_results = analysis_result
                        progress_bar.progress(100)
                        status_text.text("âœ… åˆ†æå®Œæˆï¼")
                    else:
                        progress_bar.progress(100)
                        status_text.text("âœ… ç”Ÿæˆå®Œæˆï¼")

                    st.success(f"âœ… æˆåŠŸç”Ÿæˆ {result['num_generated']} å¼ å¤šè§’åº¦ç´ æï¼")
                    if save_enabled:
                        st.info(f"ğŸ’¾ ç´ æå·²ä¿å­˜è‡³: {output_dir}")
                except Exception as e:
                    st.error(f"âŒ å¤„ç†å‡ºé”™: {e}")
                    import traceback
                    st.code(traceback.format_exc())

    # æ˜¾ç¤ºç”Ÿæˆç»“æœå’Œåˆ†æ
    if st.session_state.generated_images:
        st.markdown("---")
        st.subheader("ğŸ¨ ç”Ÿæˆçš„å¤šè§’åº¦ç´ æï¼ˆå¸¦æ£€æµ‹æ¡†ï¼‰")
        num_cols = 4
        images = st.session_state.generated_images
        for i in range(0, len(images), num_cols):
            cols = st.columns(num_cols)
            for j, col in enumerate(cols):
                if i + j < len(images):
                    img_path = Path(images[i + j])
                    if img_path.exists():
                        col.image(Image.open(img_path), caption=img_path.name, use_column_width=True)

        # æ˜¾ç¤ºç½®ä¿¡åº¦ç»Ÿè®¡
        if st.session_state.confidence_stats:
            st.markdown("---")
            st.subheader("ğŸ“Š å„ç±»åˆ«å¹³å‡ç½®ä¿¡åº¦ç»Ÿè®¡")
            
            confidence_data = []
            for class_name, stats in st.session_state.confidence_stats.items():
                confidence_data.append({
                    'ç±»åˆ«': class_name,
                    'æ£€æµ‹æ•°é‡': stats['count'],
                    'å¹³å‡ç½®ä¿¡åº¦': f"{stats['avg_confidence']*100:.2f}%",
                    'æœ€é«˜ç½®ä¿¡åº¦': f"{stats['max_confidence']*100:.2f}%",
                    'æœ€ä½ç½®ä¿¡åº¦': f"{stats['min_confidence']*100:.2f}%"
                })
            
            if confidence_data:
                df_confidence = pd.DataFrame(confidence_data)
                st.dataframe(df_confidence, use_container_width=True, hide_index=True)
                
                fig = go.Figure()
                fig.add_trace(go.Bar(
                    x=[item['ç±»åˆ«'] for item in confidence_data],
                    y=[float(item['å¹³å‡ç½®ä¿¡åº¦'].rstrip('%')) for item in confidence_data],
                    text=[item['å¹³å‡ç½®ä¿¡åº¦'] for item in confidence_data],
                    textposition='auto',
                    marker=dict(
                        color=[float(item['å¹³å‡ç½®ä¿¡åº¦'].rstrip('%')) for item in confidence_data],
                        colorscale='Viridis',
                        showscale=True,
                        colorbar=dict(title="ç½®ä¿¡åº¦ (%)")
                    )
                ))
                fig.update_layout(
                    title="å„ç±»åˆ«å¹³å‡ç½®ä¿¡åº¦å¯¹æ¯”",
                    xaxis_title="ç±»åˆ«",
                    yaxis_title="å¹³å‡ç½®ä¿¡åº¦ (%)",
                    height=500,
                    xaxis_tickangle=-45
                )
                st.plotly_chart(fig, use_container_width=True)

    # æ˜¾ç¤º8ç»´åº¦åˆ†æç»“æœ
    if st.session_state.analysis_results:
        st.markdown("---")
        st.subheader("ğŸ“Š 8ç»´åº¦é›·è¾¾å›¾åˆ†æ")
        avg_scores = st.session_state.analysis_results['analysis']['average_scores']
        overall_quality = st.session_state.analysis_results['recommendations']['overall_quality']
        
        # åˆ¤æ–­æ˜¯å¦éœ€è¦å¢å¼ºè®­ç»ƒ
        needs_enhancement = overall_quality < 60.0
        
        fig = go.Figure()
        dimensions = [
            "å›¾ç‰‡æ•°æ®é‡","æ‹æ‘„å…‰ç…§è´¨é‡","ç›®æ ‡å°ºå¯¸","ç›®æ ‡å®Œæ•´æ€§",
            "æ•°æ®å‡è¡¡åº¦","äº§å“ä¸°å¯Œåº¦","ç›®æ ‡å¯†é›†åº¦","åœºæ™¯å¤æ‚åº¦"
        ]
        values = [avg_scores.get(dim,0) for dim in dimensions]
        fig.add_trace(go.Scatterpolar(
            r=values + [values[0]],
            theta=dimensions + [dimensions[0]],
            fill='toself',
            name='ç»´åº¦å¾—åˆ†',
            line=dict(color='rgb(31,119,180)', width=3),
            fillcolor='rgba(31,119,180,0.25)'
        ))
        avg_score = np.mean(values)
        fig.add_trace(go.Scatterpolar(
            r=[avg_score]*(len(dimensions)+1),
            theta=dimensions + [dimensions[0]],
            name=f'å¹³å‡çº¿ ({avg_score:.1f}%)',
            line=dict(color='rgb(255,127,14)', width=2, dash='dash')
        ))
        fig.update_layout(
            polar=dict(
                radialaxis=dict(visible=True, range=[0,100]),
                angularaxis=dict(rotation=90, direction='counterclockwise')
            ),
            showlegend=True,
            title="8ç»´åº¦è´¨é‡åˆ†æé›·è¾¾å›¾",
            height=600
        )
        st.plotly_chart(fig, use_container_width=True)

        col1, col2 = st.columns([2,1])
        with col1:
            st.markdown("#### ğŸ“ˆ ç»´åº¦å¾—åˆ†è¯¦æƒ…")
            score_df = pd.DataFrame([
                {"ç»´åº¦": dim, "å¾—åˆ†": f"{score:.2f}%", "ç­‰çº§": "ä¼˜ç§€ â­â­â­" if score>=90 else "è‰¯å¥½ â­â­" if score>=80 else "ä¸­ç­‰ â­" if score>=70 else "ä¸€èˆ¬" if score>=60 else "è¾ƒå·®"}
                for dim, score in avg_scores.items()
            ])
            st.dataframe(score_df, use_container_width=True, hide_index=True)
            
            # å¢å¼ºè®­ç»ƒæç¤º
            if needs_enhancement and enable_enhancement:
                st.warning(f"âš ï¸ **ç´ æè´¨é‡è¾ƒå·®ï¼ˆ{overall_quality:.2f}%ï¼‰ï¼Œå»ºè®®è¿›è¡Œå¢å¼ºè®­ç»ƒ**")
                if st.button("ğŸ¯ å¼€å§‹å¢å¼ºè®­ç»ƒ", type="primary", use_container_width=True):
                    with st.spinner("æ­£åœ¨è¿›è¡Œå¢å¼ºè®­ç»ƒï¼Œè¯·ç¨å€™..."):
                        try:
                            # ç¡®å®šå¢å¼ºè¾“å‡ºç›®å½•
                            if save_enabled and save_folder:
                                base_dir = Path(save_folder)
                                base_dir.mkdir(parents=True, exist_ok=True)
                                enhancement_dir = base_dir / f"enhanced_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
                            else:
                                enhancement_dir = Path("enhanced_materials") / f"enhancement_{int(time.time())}"
                            
                            enhancement_dir.mkdir(parents=True, exist_ok=True)
                            
                            progress_bar = st.progress(0)
                            status_text = st.empty()
                            
                            # æ‰¹é‡å¢å¼º
                            status_text.text("æ­£åœ¨å¯¹è´¨é‡è¾ƒå·®çš„ç´ æè¿›è¡Œå¢å¼ºè®­ç»ƒ...")
                            enhancement_result = st.session_state.enhancement_trainer.enhance_batch_to_excellent(
                                image_paths=st.session_state.generated_images,
                                output_dir=str(enhancement_dir),
                                target_score=target_score,
                                max_iterations=max_iterations
                            )
                            
                            st.session_state.enhancement_results = enhancement_result
                            progress_bar.progress(100)
                            status_text.text("âœ… å¢å¼ºè®­ç»ƒå®Œæˆï¼")
                            
                            # æ˜¾ç¤ºå¢å¼ºç»“æœ
                            st.success(f"âœ… å¢å¼ºè®­ç»ƒå®Œæˆï¼")
                            st.info(f"ğŸ“Š æˆåŠŸç‡: {enhancement_result['success_rate']:.2f}% | è¾¾æ ‡ç‡: {enhancement_result['achievement_rate']:.2f}%")
                            
                            if save_enabled:
                                st.info(f"ğŸ’¾ å¢å¼ºç´ æå·²ä¿å­˜è‡³: {enhancement_dir}")
                        except Exception as e:
                            st.error(f"âŒ å¢å¼ºè®­ç»ƒå‡ºé”™: {e}")
                            import traceback
                            st.code(traceback.format_exc())
            
            # æ•°æ®è¡¨ç°åˆ†æ
            st.markdown("#### ğŸ” æ•°æ®è¡¨ç°å®¢è§‚åˆ†æ")
            low_score_dims = [dim for dim, score in avg_scores.items() if score < 60 and dim != "åœºæ™¯å¤æ‚åº¦"]
            if low_score_dims:
                st.warning("**ä»¥ä¸‹ç»´åº¦å¾—åˆ†è¾ƒä½ï¼Œå¯èƒ½åŸå› ï¼š**")
                analysis_text = {
                    "å›¾ç‰‡æ•°æ®é‡": "â€¢ å›¾ç‰‡åˆ†è¾¨ç‡å¯èƒ½è¾ƒä½ï¼ˆ<1920x1080ï¼‰\nâ€¢ æ–‡ä»¶å¤§å°å¯èƒ½è¾ƒå°ï¼ˆ<2MBï¼‰\nâ€¢ å»ºè®®ï¼šä½¿ç”¨æ›´é«˜åˆ†è¾¨ç‡ç›¸æœºæ‹æ‘„",
                    "æ‹æ‘„å…‰ç…§è´¨é‡": "â€¢ å…‰ç…§æ¡ä»¶å¯èƒ½ä¸ç†æƒ³ï¼ˆè¿‡æš—/è¿‡äº®ï¼‰\nâ€¢ å¯¹æ¯”åº¦å¯èƒ½ä¸è¶³\nâ€¢ å¯èƒ½å­˜åœ¨è¿‡æ›æˆ–æ¬ æ›åŒºåŸŸ\nâ€¢ å»ºè®®ï¼šåœ¨å…‰çº¿å……è¶³ã€å‡åŒ€çš„ç¯å¢ƒä¸‹æ‹æ‘„",
                    "ç›®æ ‡å°ºå¯¸": "â€¢ æ£€æµ‹åˆ°çš„ç›®æ ‡åœ¨ç”»é¢ä¸­å æ¯”å¯èƒ½è¿‡å°ï¼ˆ<5%ï¼‰\nâ€¢ æ‹æ‘„è·ç¦»å¯èƒ½è¿‡è¿œ\nâ€¢ å»ºè®®ï¼šè°ƒæ•´æ‹æ‘„è§’åº¦å’Œè·ç¦»ï¼Œä½¿ç›®æ ‡å æ¯”åœ¨5-15%",
                    "ç›®æ ‡å®Œæ•´æ€§": "â€¢ ç›®æ ‡å¯èƒ½è¢«è£å‰ªæˆ–éƒ¨åˆ†é®æŒ¡\nâ€¢ ç›®æ ‡å¯èƒ½é è¿‘ç”»é¢è¾¹ç¼˜\nâ€¢ æ£€æµ‹ç½®ä¿¡åº¦å¯èƒ½è¾ƒä½\nâ€¢ å»ºè®®ï¼šç¡®ä¿ç›®æ ‡å®Œæ•´å‡ºç°åœ¨ç”»é¢ä¸­å¤®",
                    "æ•°æ®å‡è¡¡åº¦": "â€¢ ä¸åŒç±»åˆ«ç›®æ ‡åˆ†å¸ƒå¯èƒ½ä¸å‡è¡¡\nâ€¢ æŸäº›ç±»åˆ«ç›®æ ‡æ•°é‡è¿‡å¤šæˆ–è¿‡å°‘\nâ€¢ å»ºè®®ï¼šå¢åŠ ä¸åŒç±»åˆ«ç›®æ ‡çš„å¤šæ ·æ€§",
                    "äº§å“ä¸°å¯Œåº¦": "â€¢ æ£€æµ‹åˆ°çš„ç›®æ ‡ç±»åˆ«æ•°é‡å¯èƒ½è¾ƒå°‘ï¼ˆ<5ç±»ï¼‰\nâ€¢ åœºæ™¯ä¸­ç›®æ ‡ç±»å‹å•ä¸€\nâ€¢ å»ºè®®ï¼šåœ¨åŒä¸€åœºæ™¯ä¸­åŒ…å«5-10ä¸ªä¸åŒç±»åˆ«çš„ç›®æ ‡",
                    "ç›®æ ‡å¯†é›†åº¦": "â€¢ å•ä½é¢ç§¯å†…çš„ç›®æ ‡æ•°é‡å¯èƒ½è¿‡å°‘ï¼ˆ<5ä¸ª/ç™¾ä¸‡åƒç´ ï¼‰\nâ€¢ åœºæ™¯å¯èƒ½è¿‡äºç©ºæ—·\nâ€¢ å»ºè®®ï¼šå¢åŠ åœºæ™¯ä¸­çš„ç›®æ ‡å¯†åº¦"
                }
                for dim in low_score_dims:
                    st.markdown(f"**{dim}** ({avg_scores[dim]:.2f}%):")
                    st.markdown(analysis_text.get(dim, "æš‚æ— å…·ä½“åˆ†æ"))
            else:
                st.success("âœ… æ‰€æœ‰ç»´åº¦å¾—åˆ†å‡åœ¨åˆç†èŒƒå›´å†…")
        with col2:
            st.markdown("#### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯")
            st.metric("æ•´ä½“è´¨é‡", f"{overall_quality:.2f}%")
            st.metric("ç”Ÿæˆç´ ææ•°", len(st.session_state.generated_images))
            st.metric("åˆ†æç´ ææ•°", st.session_state.analysis_results['analysis']['total_images'])
            
            if needs_enhancement:
                st.warning("âš ï¸ è´¨é‡è¾ƒå·®")
            elif overall_quality >= 90:
                st.success("âœ… ä¼˜ç§€")
            elif overall_quality >= 80:
                st.info("âœ… è‰¯å¥½")
            elif overall_quality >= 70:
                st.info("âœ… ä¸­ç­‰")
            else:
                st.info("âœ… ä¸€èˆ¬")

        # æ˜¾ç¤ºå¢å¼ºè®­ç»ƒç»“æœ
        if st.session_state.enhancement_results:
            st.markdown("---")
            st.subheader("ğŸ¯ å¢å¼ºè®­ç»ƒç»“æœ")
            
            enhancement_result = st.session_state.enhancement_results
            
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("æ€»ç´ ææ•°", enhancement_result['total_images'])
            with col2:
                st.metric("æˆåŠŸå¢å¼º", enhancement_result['successful'])
            with col3:
                st.metric("è¾¾åˆ°ç›®æ ‡", enhancement_result['target_achieved'])
            with col4:
                st.metric("æˆåŠŸç‡", f"{enhancement_result['success_rate']:.2f}%")
            
            # æ˜¾ç¤ºå¢å¼ºå†å²
            st.markdown("#### ğŸ“ˆ å¢å¼ºå†å²è®°å½•")
            enhancement_history_data = []
            for result in enhancement_result['results']:
                if result.get('success', False):
                    enhancement_history_data.append({
                        'ç´ æ': Path(result.get('original_path', '')).name,
                        'åˆå§‹åˆ†æ•°': f"{result.get('enhancement_history', [{}])[0].get('score', 0):.2f}%" if result.get('enhancement_history') else "N/A",
                        'æœ€ç»ˆåˆ†æ•°': f"{result.get('final_score', 0):.2f}%",
                        'æå‡å¹…åº¦': f"+{result.get('improvement', 0):.2f}%",
                        'è¿­ä»£æ¬¡æ•°': result.get('iterations', 0),
                        'æ˜¯å¦è¾¾æ ‡': "âœ…" if result.get('target_achieved', False) else "âŒ"
                    })
            
            if enhancement_history_data:
                st.dataframe(pd.DataFrame(enhancement_history_data), use_container_width=True, hide_index=True)
                
                # ç»˜åˆ¶æå‡å¹…åº¦å›¾è¡¨
                fig = go.Figure()
                fig.add_trace(go.Bar(
                    x=[item['ç´ æ'] for item in enhancement_history_data],
                    y=[float(item['æå‡å¹…åº¦'].lstrip('+').rstrip('%')) for item in enhancement_history_data],
                    text=[item['æå‡å¹…åº¦'] for item in enhancement_history_data],
                    textposition='auto',
                    marker=dict(color='green')
                ))
                fig.update_layout(
                    title="ç´ æè´¨é‡æå‡å¹…åº¦",
                    xaxis_title="ç´ æ",
                    yaxis_title="æå‡å¹…åº¦ (%)",
                    height=400,
                    xaxis_tickangle=-45
                )
                st.plotly_chart(fig, use_container_width=True)

        st.markdown("#### ğŸ“‹ ç´ æè´¨é‡è¯„ä¼°")
        quality_data = []
        for item in st.session_state.analysis_results['quality_evaluation']:
            quality_data.append({
                "ç´ æ": Path(item['image_path']).name,
                "å¹³å‡å¾—åˆ†": f"{item['average_score']:.2f}%",
                "è´¨é‡ç­‰çº§": item['quality_level']
            })
        st.dataframe(pd.DataFrame(quality_data), use_container_width=True, hide_index=True)
'@ | Set-Content "app\web\material_generator_app.py" -Encoding UTF8

Write-Host "âœ… Streamlitåº”ç”¨æ›´æ–°å®Œæˆ" -ForegroundColor Green
```

### æ­¥éª¤4ï¼šéªŒè¯æ¨¡å—å¯¼å…¥

```powershell
# éªŒè¯æ‰€æœ‰æ¨¡å—å¯ä»¥æ­£å¸¸å¯¼å…¥
python -c "
import sys
sys.path.insert(0, '.')
try:
    from agents.material_enhancement_trainer import MaterialEnhancementTrainer
    print('âœ… MaterialEnhancementTrainer å¯¼å…¥æˆåŠŸ')
    
    from agents.image_multi_angle_generator import ImageMultiAngleGenerator
    print('âœ… ImageMultiAngleGenerator å¯¼å…¥æˆåŠŸ')
    
    from agents.image_quality_analyzer import ImageQualityAnalyzer
    print('âœ… ImageQualityAnalyzer å¯¼å…¥æˆåŠŸ')
    
    from agents.material_generator_agent import MaterialGeneratorAgent
    print('âœ… MaterialGeneratorAgent å¯¼å…¥æˆåŠŸ')
    
    print('`nâœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥éªŒè¯é€šè¿‡ï¼')
except Exception as e:
    print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
    import traceback
    traceback.print_exc()
"
```

### æ­¥éª¤5ï¼šæµ‹è¯•å¢å¼ºè®­ç»ƒåŠŸèƒ½

```powershell
# åˆ›å»ºæµ‹è¯•è„šæœ¬
@'
"""
æµ‹è¯•ç´ æå¢å¼ºè®­ç»ƒåŠŸèƒ½
"""
import sys
from pathlib import Path
sys.path.insert(0, '.')

from agents.material_enhancement_trainer import MaterialEnhancementTrainer

# åˆå§‹åŒ–è®­ç»ƒå™¨
trainer = MaterialEnhancementTrainer()

# æµ‹è¯•å•å¼ å›¾ç‰‡å¢å¼ºï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡è·¯å¾„ï¼‰
test_image = "test_images/test_input.jpg"
if Path(test_image).exists():
    print(f"å¼€å§‹å¢å¼ºæµ‹è¯•: {test_image}")
    result = trainer.enhance_to_excellent(
        test_image,
        "test_enhanced_output",
        target_score=90.0,
        max_iterations=5
    )
    print(f"\nå¢å¼ºç»“æœ:")
    print(f"  æˆåŠŸ: {result['success']}")
    print(f"  è¾¾åˆ°ç›®æ ‡: {result['target_achieved']}")
    print(f"  æœ€ç»ˆåˆ†æ•°: {result['final_score']:.2f}%")
    print(f"  è¿­ä»£æ¬¡æ•°: {result['iterations']}")
    print(f"  æå‡å¹…åº¦: +{result['improvement']:.2f}%")
    print(f"  è¾“å‡ºè·¯å¾„: {result['final_image_path']}")
else:
    print(f"æµ‹è¯•å›¾ç‰‡ä¸å­˜åœ¨: {test_image}")
    print("è¯·å…ˆå‡†å¤‡æµ‹è¯•å›¾ç‰‡")
'@ | Set-Content "test_enhancement.py" -Encoding UTF8

Write-Host "`nâœ… æµ‹è¯•è„šæœ¬åˆ›å»ºå®Œæˆ" -ForegroundColor Green
Write-Host "`nå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•å¢å¼ºåŠŸèƒ½ï¼š" -ForegroundColor Cyan
Write-Host "python test_enhancement.py" -ForegroundColor Yellow
```

### æ­¥éª¤6ï¼šå¯åŠ¨Streamlitåº”ç”¨

```powershell
# å¯åŠ¨Streamlitåº”ç”¨
Write-Host "`nğŸš€ å¯åŠ¨Streamlitåº”ç”¨..." -ForegroundColor Cyan
Write-Host "`nè®¿é—®åœ°å€: http://localhost:8501
2" -ForegroundColor Yellow
Write-Host "`næŒ‰ Ctrl+C åœæ­¢æœåŠ¡" -ForegroundColor Gray

conda activate uav_advupdfa
streamlit run app\web\material_generator_app.py --server.port 8502 --server.headless true
```

---

## ğŸ“Š åŠŸèƒ½è¯´æ˜

### 1. è‡ªåŠ¨è´¨é‡æ£€æµ‹
- ç³»ç»Ÿè‡ªåŠ¨åˆ†æç”Ÿæˆç´ æçš„8ç»´åº¦è´¨é‡
- å½“æ•´ä½“è´¨é‡ < 60åˆ†æ—¶ï¼Œè‡ªåŠ¨æç¤º"è´¨é‡è¾ƒå·®"
- æ˜¾ç¤º"å¼€å§‹å¢å¼ºè®­ç»ƒ"æŒ‰é’®

### 2. æ™ºèƒ½å¢å¼ºç­–ç•¥é€‰æ‹©
ç³»ç»Ÿæ ¹æ®ä½åˆ†ç»´åº¦è‡ªåŠ¨é€‰æ‹©å¢å¼ºç®—æ³•ï¼š

| ä½åˆ†ç»´åº¦ | åº”ç”¨çš„å¢å¼ºç®—æ³• |
|---------|--------------|
| å›¾ç‰‡æ•°æ®é‡ | è¶…åˆ†è¾¨ç‡å¢å¼º |
| æ‹æ‘„å…‰ç…§è´¨é‡ | å…‰ç…§æ ¡æ­£ + å¯¹æ¯”åº¦å¢å¼º |
| ç›®æ ‡å°ºå¯¸ | é”åŒ– + è¾¹ç¼˜å¢å¼º |
| ç›®æ ‡å®Œæ•´æ€§ | å»å™ª + é”åŒ– |
| æ•°æ®å‡è¡¡åº¦ | è‰²å½©å¢å¼º |
| äº§å“ä¸°å¯Œåº¦ | å¯¹æ¯”åº¦å¢å¼º + é”åŒ– |
| ç›®æ ‡å¯†é›†åº¦ | æ•´ä½“å¢å¼º |
| åœºæ™¯å¤æ‚åº¦ | çº¹ç†å¢å¼º + é”åŒ– |

### 3. è¿­ä»£å¢å¼ºæµç¨‹
1. **åˆå§‹åˆ†æ**ï¼šåˆ†æå½“å‰ç´ æè´¨é‡
2. **ç­–ç•¥é€‰æ‹©**ï¼šæ ¹æ®ä½åˆ†ç»´åº¦é€‰æ‹©å¢å¼ºç®—æ³•
3. **åº”ç”¨å¢å¼º**ï¼šæ‰§è¡Œé€‰å®šçš„å¢å¼ºç®—æ³•
4. **é‡æ–°è¯„ä¼°**ï¼šåˆ†æå¢å¼ºåçš„è´¨é‡
5. **è¿­ä»£åˆ¤æ–­**ï¼šå¦‚æœæœªè¾¾æ ‡ä¸”æœªè¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œç»§ç»­å¢å¼º
6. **å®Œæˆè¾“å‡º**ï¼šè¾¾åˆ°ç›®æ ‡åˆ†æ•°æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°æ—¶è¾“å‡ºç»“æœ

### 4. å¢å¼ºç®—æ³•è¯´æ˜

#### è¶…åˆ†è¾¨ç‡å¢å¼º
- ä½¿ç”¨Lanczosæ’å€¼æ”¾å¤§1.2å€
- ä¿æŒä¸­å¿ƒè£å‰ªå›åŸå°ºå¯¸
- æå‡å›¾ç‰‡æ•°æ®é‡ç»´åº¦

#### å…‰ç…§æ ¡æ­£
- ä½¿ç”¨CLAHEï¼ˆå¯¹æ¯”åº¦å—é™çš„è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼‰
- åœ¨LABè‰²å½©ç©ºé—´ä¸­å¤„ç†Lé€šé“
- æå‡æ‹æ‘„å…‰ç…§è´¨é‡ç»´åº¦

#### å¯¹æ¯”åº¦å¢å¼º
- åœ¨YUVè‰²å½©ç©ºé—´ä¸­å¢å¼ºYé€šé“
- ä½¿ç”¨çº¿æ€§å˜æ¢æå‡å¯¹æ¯”åº¦
- æå‡æ•´ä½“è§†è§‰æ•ˆæœ

#### é”åŒ–
- ä½¿ç”¨3x3é”åŒ–å·ç§¯æ ¸
- å¢å¼ºå›¾åƒè¾¹ç¼˜å’Œç»†èŠ‚
- æå‡ç›®æ ‡å°ºå¯¸å’Œå®Œæ•´æ€§ç»´åº¦

#### è¾¹ç¼˜å¢å¼º
- ä½¿ç”¨æ‹‰æ™®æ‹‰æ–¯ç®—å­æå–è¾¹ç¼˜
- å åŠ è¾¹ç¼˜ä¿¡æ¯åˆ°åŸå›¾
- æå‡ç›®æ ‡æ¸…æ™°åº¦

#### å»å™ª
- ä½¿ç”¨å¿«é€Ÿéå±€éƒ¨å‡å€¼å»å™ª
- ä¿ç•™è¾¹ç¼˜çš„åŒæ—¶å»é™¤å™ªå£°
- æå‡ç›®æ ‡å®Œæ•´æ€§ç»´åº¦

#### è‰²å½©å¢å¼º
- åœ¨HSVè‰²å½©ç©ºé—´ä¸­å¢å¼ºé¥±å’Œåº¦
- æå‡è‰²å½©ä¸°å¯Œåº¦
- æå‡æ•°æ®å‡è¡¡åº¦ç»´åº¦

#### çº¹ç†å¢å¼º
- ä½¿ç”¨åŒè¾¹æ»¤æ³¢ä¿ç•™è¾¹ç¼˜
- å åŠ é”åŒ–æ•ˆæœ
- æå‡åœºæ™¯å¤æ‚åº¦ç»´åº¦

#### æ•´ä½“å¢å¼º
- ç»„åˆå…‰ç…§æ ¡æ­£ã€å¯¹æ¯”åº¦å¢å¼ºã€é”åŒ–
- é€‚ç”¨äºæ— æ˜æ˜¾å¼±ç‚¹çš„ç´ æ
- å…¨é¢æå‡è´¨é‡

---

## ğŸ¯ ä½¿ç”¨æµç¨‹

1. **ä¸Šä¼ å›¾ç‰‡**ï¼šåœ¨Streamlitç•Œé¢ä¸Šä¼ æ— äººæœºå›¾ç‰‡
2. **ç”Ÿæˆç´ æ**ï¼šç‚¹å‡»"ç”Ÿæˆå¤šè§’åº¦ç´ æå¹¶åˆ†æ"
3. **æŸ¥çœ‹åˆ†æ**ï¼šæŸ¥çœ‹8ç»´åº¦é›·è¾¾å›¾å’Œè´¨é‡è¯„ä¼°
4. **åˆ¤æ–­è´¨é‡**ï¼šå¦‚æœæ•´ä½“è´¨é‡ < 60åˆ†ï¼Œç³»ç»Ÿä¼šæç¤º"è´¨é‡è¾ƒå·®"
5. **å¯åŠ¨å¢å¼º**ï¼šç‚¹å‡»"å¼€å§‹å¢å¼ºè®­ç»ƒ"æŒ‰é’®
6. **ç­‰å¾…å®Œæˆ**ï¼šç³»ç»Ÿè‡ªåŠ¨è¿­ä»£å¢å¼ºç›´åˆ°è¾¾åˆ°ç›®æ ‡åˆ†æ•°
7. **æŸ¥çœ‹ç»“æœ**ï¼šæŸ¥çœ‹å¢å¼ºå†å²è®°å½•å’Œæå‡å¹…åº¦å›¾è¡¨

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

- **æˆåŠŸç‡**ï¼š> 90%ï¼ˆç´ æèƒ½å¤ŸæˆåŠŸå¢å¼ºï¼‰
- **è¾¾æ ‡ç‡**ï¼š> 70%ï¼ˆå¢å¼ºåè¾¾åˆ°ä¼˜ç§€æ°´å¹³ï¼‰
- **å¹³å‡æå‡**ï¼š+15-30åˆ†ï¼ˆä»è¾ƒå·®æå‡åˆ°ä¼˜ç§€ï¼‰
- **è¿­ä»£æ¬¡æ•°**ï¼šé€šå¸¸3-7æ¬¡è¿­ä»£å³å¯è¾¾æ ‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è®¡ç®—èµ„æº**ï¼šå¢å¼ºè®­ç»ƒéœ€è¦ä¸€å®šçš„è®¡ç®—æ—¶é—´ï¼Œå»ºè®®ä½¿ç”¨GPUåŠ é€Ÿ
2. **å­˜å‚¨ç©ºé—´**ï¼šå¢å¼ºåçš„ç´ æä¼šå ç”¨é¢å¤–å­˜å‚¨ç©ºé—´
3. **è¿­ä»£æ¬¡æ•°**ï¼šå»ºè®®è®¾ç½®5-10æ¬¡ï¼Œè¿‡å¤šå¯èƒ½è¿‡æ‹Ÿåˆ
4. **ç›®æ ‡åˆ†æ•°**ï¼šå»ºè®®è®¾ç½®ä¸º90åˆ†ï¼ˆä¼˜ç§€æ°´å¹³ï¼‰

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šå¢å¼ºåè´¨é‡æ²¡æœ‰æå‡
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥åŸå§‹ç´ ææ˜¯å¦è¿‡äºæ¨¡ç³Šæˆ–æŸå
- å°è¯•å¢åŠ æœ€å¤§è¿­ä»£æ¬¡æ•°
- æ£€æŸ¥ç›®æ ‡åˆ†æ•°è®¾ç½®æ˜¯å¦è¿‡é«˜

### é—®é¢˜2ï¼šå¢å¼ºé€Ÿåº¦è¿‡æ…¢
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‡å°‘æœ€å¤§è¿­ä»£æ¬¡æ•°
- ä½¿ç”¨GPUåŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
- å‡å°‘æ‰¹é‡å¤„ç†çš„å›¾ç‰‡æ•°é‡

### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‡å°‘æ‰¹é‡å¤„ç†çš„å›¾ç‰‡æ•°é‡
- é™ä½å›¾ç‰‡åˆ†è¾¨ç‡
- å…³é—­å…¶ä»–å ç”¨å†…å­˜çš„ç¨‹åº

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ­¥éª¤1ï¼šç´ æå¢å¼ºè®­ç»ƒå™¨æ¨¡å—åˆ›å»ºå®Œæˆ
- [ ] æ­¥éª¤2ï¼šagentsåŒ…æ›´æ–°å®Œæˆ
- [ ] æ­¥éª¤3ï¼šStreamlitåº”ç”¨æ›´æ–°å®Œæˆ
- [ ] æ­¥éª¤4ï¼šæ¨¡å—å¯¼å…¥éªŒè¯é€šè¿‡
- [ ] æ­¥éª¤5ï¼šæµ‹è¯•å¢å¼ºåŠŸèƒ½æ­£å¸¸
- [ ] æ­¥éª¤6ï¼šStreamlitåº”ç”¨å¯åŠ¨æˆåŠŸ
- [ ] åŠŸèƒ½æµ‹è¯•ï¼šä¸Šä¼ å›¾ç‰‡ â†’ ç”Ÿæˆç´ æ â†’ è´¨é‡åˆ†æ â†’ å¢å¼ºè®­ç»ƒ â†’ æŸ¥çœ‹ç»“æœ

---

**éƒ¨ç½²å®Œæˆåï¼Œç³»ç»Ÿå°†å…·å¤‡æ™ºèƒ½ç´ æå¢å¼ºè®­ç»ƒåŠŸèƒ½ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å°†è´¨é‡è¾ƒå·®çš„ç´ ææå‡åˆ°ä¼˜ç§€æ°´å¹³ï¼** ğŸ‰

